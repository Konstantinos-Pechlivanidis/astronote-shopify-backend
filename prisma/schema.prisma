generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Shop {
  id                    String                 @id @default(cuid())
  shopDomain            String                 @unique
  shopName              String?
  accessToken           String?
  status                String                 @default("active")
  country               String?
  currency              String                 @default("EUR")
  credits               Int                    @default(0)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  automations           UserAutomation[]
  automationLogs        AutomationLog[]
  campaigns             Campaign[]
  contacts              Contact[]
  discounts             DiscountLink[]
  messages              MessageLog[]
  segments              Segment[]
  templates             TemplateUsage[]
  wallet                Wallet?
  transactions          WalletTransaction[]
  creditTransactions    CreditTransaction[]
  creditReservations    CreditReservation[]
  billingTransactions   BillingTransaction[]
  purchases             Purchase[]
  settings              ShopSettings?
  eventProcessingStates EventProcessingState[]

  // Subscription fields
  stripeCustomerId           String?               @db.VarChar(255)
  stripeSubscriptionId       String?               @db.VarChar(255)
  planType                   SubscriptionPlanType?
  subscriptionStatus         SubscriptionStatus    @default(inactive)
  lastFreeCreditsAllocatedAt DateTime?

  @@index([status, createdAt])
  @@index([country])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([subscriptionStatus])
}

model Contact {
  id          String              @id @default(cuid())
  shopId      String
  firstName   String?
  lastName    String?
  phoneE164   String
  email       String?
  gender      String? // "male", "female", "other", or null
  birthDate   DateTime? // Required for birthday automations
  tags        String[]            @default([])
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  smsConsent  SmsConsent          @default(unknown)
  recipients  CampaignRecipient[]
  clickEvents ClickEvent[]
  shop        Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  memberships SegmentMembership[]

  @@unique([shopId, phoneE164])
  @@unique([shopId, email])
  @@index([shopId, phoneE164])
  @@index([shopId, email])
  @@index([shopId, smsConsent])
  @@index([shopId, birthDate])
  @@index([shopId, createdAt])
  @@index([shopId, gender])
}

model Segment {
  id          String              @id @default(cuid())
  shopId      String
  name        String
  ruleJson    Json
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  shop        Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  memberships SegmentMembership[]

  @@unique([shopId, name])
  @@index([shopId, name])
  @@index([shopId, createdAt])
}

model SegmentMembership {
  id        String  @id @default(cuid())
  segmentId String
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  segment   Segment @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  @@unique([segmentId, contactId])
}

model Campaign {
  id                 String              @id @default(cuid())
  shopId             String
  name               String
  message            String
  audience           String
  discountId         String?
  scheduleAt         DateTime?
  recurringDays      Int?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  scheduleType       ScheduleType
  status             CampaignStatus      @default(draft)
  priority           CampaignPriority    @default(normal)
  shop               Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  metrics            CampaignMetrics?
  recipients         CampaignRecipient[]
  messages           MessageLog[]
  creditTransactions CreditTransaction[]
  creditReservations CreditReservation[]
  ClickEvent         ClickEvent[]

  @@unique([shopId, name])
  @@index([shopId, status])
  @@index([shopId, createdAt])
  @@index([shopId, scheduleAt])
  @@index([priority])
}

model CampaignRecipient {
  id             String       @id @default(cuid())
  campaignId     String
  contactId      String?
  phoneE164      String
  status         String
  mittoMessageId String?
  bulkId         String? // Mitto bulkId for batch tracking (bulk SMS)
  retryCount     Int          @default(0) // Track retry attempts for idempotency
  sentAt         DateTime?
  deliveredAt    DateTime?
  error          String?
  deliveryStatus String? // Mitto delivery status: Delivered, Failed, Queued, etc.
  senderNumber   String? // Sender number used for this message
  campaign       Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact        Contact?     @relation(fields: [contactId], references: [id])
  clickEvents    ClickEvent[]

  @@unique([campaignId, phoneE164]) // Prevent duplicate messages to same phone in same campaign
  @@index([campaignId, status]) // For filtering by campaign and status
  @@index([campaignId, phoneE164]) // For quick lookups during SMS sending
  @@index([sentAt]) // For time-based queries
  @@index([status]) // For status-based filtering
  @@index([bulkId]) // For batch-level queries (bulk SMS)
  @@index([mittoMessageId]) // For DLR webhook lookups
}

model CampaignMetrics {
  id             String   @id @default(cuid())
  campaignId     String   @unique
  totalSent      Int      @default(0) // Actually sent (status='sent') - Phase 2.2
  totalDelivered Int      @default(0)
  totalFailed    Int      @default(0)
  totalProcessed Int      @default(0) // Processed = sent + failed (Phase 2.2)
  totalClicked   Int      @default(0)
  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model ClickEvent {
  id          String             @id @default(cuid())
  campaignId  String
  recipientId String? // Optional: link to CampaignRecipient
  contactId   String? // Optional: link to Contact
  phoneE164   String // Phone number that clicked
  linkType    String             @default("unsubscribe") // unsubscribe, discount, etc.
  clickedAt   DateTime           @default(now())
  ipAddress   String? // Optional: IP address for analytics
  userAgent   String? // Optional: User agent for analytics
  campaign    Campaign           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  recipient   CampaignRecipient? @relation(fields: [recipientId], references: [id], onDelete: SetNull)
  contact     Contact?           @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@unique([campaignId, recipientId, linkType]) // Prevent duplicate clicks for same campaign+recipient+linkType
  @@index([campaignId])
  @@index([recipientId])
  @@index([contactId])
  @@index([phoneE164])
  @@index([clickedAt])
  @@index([campaignId, clickedAt])
}

model MessageLog {
  id                 String              @id @default(cuid())
  shopId             String
  phoneE164          String
  provider           String
  providerMsgId      String?
  payload            Json?
  error              String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  campaignId         String?
  direction          MessageDirection
  status             MessageStatus?
  deliveryStatus     String? // Mitto delivery status
  senderNumber       String? // Sender number used
  campaign           Campaign?           @relation(fields: [campaignId], references: [id])
  shop               Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  creditTransactions CreditTransaction[]

  @@index([shopId, direction])
  @@index([shopId, status])
  @@index([shopId, createdAt])
  @@index([shopId, providerMsgId])
  @@index([shopId, phoneE164])
  @@index([campaignId, status]) // For campaign status queries
  @@index([createdAt, status]) // For time-based filtering with status
  @@index([providerMsgId]) // For quick lookups by provider message ID
}

model Wallet {
  id                 String              @id @default(cuid())
  shopId             String              @unique
  balance            Int                 @default(0)
  totalUsed          Int                 @default(0)
  totalBought        Int                 @default(0)
  active             Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  shop               Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  creditTransactions CreditTransaction[]
}

model SmsPackage {
  id          String   @id @default(cuid())
  name        String
  credits     Int
  priceCents  Int
  currency    String   @default("EUR")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  description String?
  features    String[] @default([])
  isActive    Boolean  @default(true)
  isPopular   Boolean  @default(false)
}

model Package {
  id         String     @id @default(cuid())
  name       String     @unique
  units      Int // credits included
  priceCents Int // price in cents (for reference)
  active     Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  Purchase   Purchase[]

  // Stripe price IDs (optional, can be set via env or admin)
  stripePriceIdEur String? @db.VarChar(255)
  stripePriceIdUsd String? @db.VarChar(255)

  @@index([stripePriceIdEur])
  @@index([stripePriceIdUsd])
}

model Purchase {
  id         String        @id @default(cuid())
  shopId     String
  packageId  String
  package    Package       @relation(fields: [packageId], references: [id], onDelete: Restrict)
  units      Int
  priceCents Int
  status     PaymentStatus @default(pending)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Stripe integration
  stripeSessionId       String? @unique
  stripePaymentIntentId String?
  stripeCustomerId      String?
  stripePriceId         String?
  currency              String? @db.VarChar(3)

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([packageId])
  @@index([stripeSessionId])
  @@index([status])
  @@index([shopId, status])
}

model WalletTransaction {
  id        String          @id @default(cuid())
  shopId    String
  credits   Int
  ref       String?
  meta      Json?
  createdAt DateTime        @default(now())
  type      TransactionType
  shop      Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
}

model TemplateUsage {
  id         String    @id @default(cuid())
  shopId     String
  templateId String
  usedCount  Int       @default(0)
  lastUsedAt DateTime?
  shop       Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  template   Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)
}

model Automation {
  id              String            @id @default(cuid())
  title           String
  description     String?
  triggerEvent    AutomationTrigger
  defaultMessage  String
  isSystemDefault Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  userAutomations UserAutomation[]
}

model UserAutomation {
  id           String     @id @default(cuid())
  shopId       String
  automationId String
  userMessage  String? // Custom message by user
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  shop         Shop       @relation(fields: [shopId], references: [id], onDelete: Cascade)
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@unique([shopId, automationId])
}

model AutomationLog {
  id           String   @id @default(cuid())
  automationId String
  storeId      String
  status       String // 'sent', 'skipped', 'failed'
  reason       String? // Reason for skip/failure
  triggeredAt  DateTime @default(now())
  createdAt    DateTime @default(now())
  shop         Shop     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, status])
  @@index([automationId, triggeredAt])
}

model EventProcessingState {
  id              String   @id @default(cuid())
  shopId          String
  automationType  String // 'welcome', 'order_placed', 'order_fulfilled'
  lastEventId     String? // Last processed Shopify event GID
  lastProcessedAt DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, automationType])
  @@index([shopId, automationType])
}

model DiscountLink {
  id         String   @id @default(cuid())
  shopId     String
  code       String
  campaignId String?
  createdAt  DateTime @default(now())
  shop       Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, code])
}

enum SmsConsent {
  opted_in
  opted_out
  unknown
}

enum CampaignStatus {
  draft
  scheduled
  sending
  sent
  failed
  cancelled
}

enum CampaignPriority {
  low
  normal
  high
  urgent
}

enum ScheduleType {
  immediate
  scheduled
  recurring
}

enum MessageDirection {
  outbound
  inbound
}

enum MessageStatus {
  queued
  sent
  delivered
  failed
  received
}

enum TransactionType {
  purchase
  debit
  credit
  refund
  adjustment
}

enum SubscriptionPlanType {
  starter
  pro
}

enum SubscriptionStatus {
  active
  inactive
  cancelled
}

enum CreditTxnType {
  credit // e.g. admin topup, purchase, subscription credits
  debit // e.g. campaign enqueue
  refund // e.g. immediate provider hard-fail, stripe refund
}

enum AutomationTrigger {
  welcome
  abandoned_cart
  order_confirmation
  shipping_update
  delivery_confirmation
  review_request
  reorder_reminder
  birthday
  customer_inactive
  cart_abandoned
  order_placed
  order_fulfilled
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

model ShopSettings {
  id           String   @id @default(cuid())
  shopId       String   @unique
  senderNumber String? // Custom sender number for SMS
  senderName   String? // Custom sender name
  timezone     String   @default("UTC")
  currency     String   @default("EUR")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  shop         Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
}

model BillingTransaction {
  id              String   @id @default(cuid())
  shopId          String
  creditsAdded    Int
  amount          Int // Amount in cents
  currency        String   @default("EUR")
  packageType     String
  stripeSessionId String
  stripePaymentId String?
  status          String   @default("pending") // pending, completed, failed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, createdAt])
}

model CreditTransaction {
  id           String        @id @default(cuid())
  shopId       String
  shop         Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  type         CreditTxnType
  amount       Int // positive integer (credits)
  balanceAfter Int // snapshot of wallet balance after this txn
  reason       String?       @db.VarChar(200)
  campaignId   String?
  campaign     Campaign?     @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  messageId    String?
  message      MessageLog?   @relation(fields: [messageId], references: [id], onDelete: SetNull)
  meta         Json?
  createdAt    DateTime      @default(now())
  walletId     String?
  wallet       Wallet?       @relation(fields: [walletId], references: [id], onDelete: SetNull)

  @@index([shopId])
  @@index([campaignId])
  @@index([messageId])
  @@index([walletId])
  @@index([createdAt])
  @@index([reason])
  @@index([shopId, reason])
}

model CreditReservation {
  id         String    @id @default(cuid())
  shopId     String
  shop       Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  campaignId String? // Optional: link to campaign
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  amount     Int // Credits reserved
  status     String    @default("active") // active, released, expired
  expiresAt  DateTime? // Optional expiration
  releasedAt DateTime? // When reservation was released
  meta       Json? // Additional metadata
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([shopId])
  @@index([campaignId])
  @@index([status])
  @@index([expiresAt])
  @@index([shopId, status])
}

model Template {
  id                   String          @id @default(cuid())
  title                String
  category             String
  content              String
  previewImage         String?
  tags                 String[]        @default([])
  isPublic             Boolean         @default(true)
  isSystemDefault      Boolean         @default(false)
  // Statistics fields
  conversionRate       Float? // Conversion rate percentage (e.g., 33.5 for 33.5%)
  productViewsIncrease Float? // Product views increase percentage (e.g., 55.0 for 55%)
  clickThroughRate     Float? // Click-through rate percentage
  averageOrderValue    Float? // Average order value increase percentage
  customerRetention    Float? // Customer retention improvement percentage
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  usage                TemplateUsage[]
}

model QueueJob {
  id          String    @id @default(cuid())
  queueName   String
  jobName     String
  data        String // JSON string
  status      String    @default("pending") // pending, processing, completed, failed
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  priority    Int       @default(0)
  delay       DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?
  result      String? // JSON string
  error       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([queueName, status])
  @@index([status, createdAt])
  @@index([delay])
}

model ShopifySession {
  id          String    @id
  shop        String
  state       String?
  isOnline    Boolean   @default(false)
  scope       String?
  expires     DateTime?
  accessToken String?
  userId      String?
  sessionData String // JSON string
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([shop])
  @@index([expires])
  @@index([shop, isOnline])
}

model RateLimitRecord {
  id        String   @id @default(cuid())
  key       String
  createdAt DateTime @default(now())

  @@index([key, createdAt])
  @@index([createdAt])
}
